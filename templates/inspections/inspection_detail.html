{% extends "base.html" %}
{% block title %}Inspection Details{% endblock %}

{% block content %}
<div class="container-fluid">

    <h1 class="mb-4">Inspection Details</h1>

    <!-- Summary -->
    <div class="card mb-4">
        <div class="card-body">
            <h4>{{ inspection.school.name }}</h4>

            <p><strong>Date:</strong> {{ inspection.date }}</p>

            <p>
                <strong>Status:</strong>
                <span class="badge 
                    {% if inspection.status == 'PASSED' %}bg-success
                    {% elif inspection.status == 'FAILED' %}bg-danger
                    {% elif inspection.status == 'PENDING' %}bg-warning text-dark
                    {% else %}bg-secondary
                    {% endif %}
                ">
                    {{ inspection.get_status_display }}
                </span>
            </p>

            {% if inspection.notes %}
            <p class="mt-3">
                <strong>Notes:</strong><br>
                <span class="text-muted">{{ inspection.notes|linebreaks }}</span>
            </p>
            {% endif %}
        </div>
    </div>


    <!-- Perform Inspection Button (Inspector Only) -->
    {% if user.appuser.role == "INSPECTOR" and inspection.inspector_id == user.appuser.id %}

        {% if inspection.status == "PENDING" %}
            <a href="{% url 'inspections:inspection_perform' inspection.pk %}"
                class="btn btn-primary mb-3">
                Perform Inspection
            </a>

        {% elif inspection.status == "FAILED" and not unresolved_actions %}
            <!-- Optional: allow inspector to redo full inspection once all CA's resolved -->
            <a href="{% url 'inspections:inspection_perform' inspection.pk %}"
                class="btn btn-outline-primary mb-3">
                Perform Inspection Again
            </a>
        {% endif %}

    {% endif %}

    <!-- Reinspect All Button -->
    {% if unresolved_actions %}
        <a href="{% url 'inspections:inspection_perform' inspection.pk %}?reinspect_all=1"
           class="btn btn-success mb-3">
            Reinspect All Failed Items ({{ unresolved_actions.count }})
        </a>
    {% endif %}

    <!-- Checklist Items -->
    <div class="card">
        <div class="card-header bg-light">
            <strong>Checklist Items</strong>
        </div>

        <ul class="list-group list-group-flush">
            {% for item in inspection.inspection_items.all %}
            {% with action=item.corrective_actions.first %}

            <li class="list-group-item d-flex justify-content-between align-items-start">

                <div class="flex-grow-1">

                    <strong>{{ item.checklist_item.text }}</strong><br>

                    <!-- Pass/Fail/Pending -->
                    {% if inspection.status == 'PENDING' %}
                        <span class="badge bg-secondary">Awaiting Inspection</span>
                    {% else %}
                        {% if item.passed %}
                            <span class="badge bg-success">Passed</span>
                        {% else %}
                            <span class="badge bg-danger">Failed</span>
                        {% endif %}
                    {% endif %}

                    <!-- Corrective Action Badges -->
                    {% if action %}
                        {% if action.status == "OPEN" %}
                            <span class="badge bg-danger ms-2">Corrective Action Required</span>
                        {% elif action.status == "IN_PROGRESS" %}
                            <span class="badge bg-warning text-dark ms-2">In Progress</span>
                        {% elif action.status == "AWAITING_REINSPECTION" %}
                            <span class="badge bg-info text-dark ms-2">Awaiting Reinspection</span>
                        {% elif action.status == "REINSPECTED" %}
                            <span class="badge bg-success ms-2">Reinspected</span>
                        {% endif %}
                    {% endif %}
                </div>

                <div class="text-end">

                    {% if action %}
                        <!-- View Action -->
                        <a href="{% url 'inspections:corrective_action_detail' action.pk %}"
                           class="btn btn-sm btn-outline-primary mb-1">
                            View Action
                        </a>
                    {% endif %}

                    {% if action and action.status == "AWAITING_REINSPECTION" %}
                        <!-- Single-item Reinspection -->
                        <a href="{% url 'inspections:inspection_perform' inspection.pk %}?action={{ action.pk }}"
                           class="btn btn-sm btn-success">
                            Reinspect
                        </a>
                    {% endif %}
                </div>

            </li>

            {% endwith %}
            {% endfor %}
        </ul>
    </div>
</div>
{% endblock %}
