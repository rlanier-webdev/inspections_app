{% extends "base.html" %}
{% block title %}Inspection Details{% endblock %}

{% block content %}
<div class="container-fluid">

    <h1 class="mb-4">Inspection Details</h1>

    <!-- ===== INSPECTION SUMMARY ===== -->
    <div class="card mb-4">
        <div class="card-body">
            <h4 class="mb-1">{{ inspection.school.name }}</h4>

            <p class="mb-1"><strong>Date:</strong> {{ inspection.date }}</p>

            <p class="mb-1">
                <strong>Status:</strong>
                <span class="badge 
                    {% if inspection.status == 'PASSED' %}bg-success
                    {% elif inspection.status == 'FAILED' %}bg-danger
                    {% elif inspection.status == 'PENDING' %}bg-warning text-dark
                    {% else %}bg-secondary
                    {% endif %}
                ">
                    {{ inspection.get_status_display }}
                </span>
            </p>

            <!-- Inspector & Manager Info -->
            <p class="mb-0">
                <strong>Inspector:</strong>
                {{ inspection.inspector.full_name|default:"—" }} <br>

                <strong>Manager:</strong>
                {{ inspection.manager.full_name|default:"—" }}
            </p>
        </div>
    </div>

    <!-- ===== PERFORM INSPECTION BUTTON ===== -->
    {% if inspection.status == "PENDING" %}
        {% if request.user.appuser.role == "ADMIN" or inspection.inspector == request.user.appuser %}
            <a href="{% url 'inspections:inspection_perform' inspection.pk %}"
               class="btn btn-primary mb-4">
                Perform Inspection
            </a>
        {% endif %}
    {% endif %}

    <!-- ===== CHECKLIST ITEMS ===== -->
    <div class="card">
        <div class="card-header bg-light">
            <strong>Checklist Items</strong>
        </div>

        <ul class="list-group list-group-flush">
            {% for item in inspection.inspection_items.all %}
            {% with action=item.corrective_actions.first %}
            <li class="list-group-item d-flex justify-content-between align-items-center">

                <!-- Left Column: Checklist Item + Status -->
                <div>
                    <strong>{{ item.checklist_item.text }}</strong>
                    <br>

                    <!-- === PASS / FAIL / PENDING DISPLAY === -->
                    {% if inspection.status == 'PENDING' %}
                        <span class="badge bg-secondary">Awaiting Inspection</span>
                    {% else %}
                        {% if item.passed is True %}
                            <span class="badge bg-success">Passed</span>
                        {% elif item.passed is False %}
                            <span class="badge bg-danger">Failed</span>
                        {% else %}
                            <span class="badge bg-secondary">Not Checked</span>
                        {% endif %}
                    {% endif %}

                    <!-- === CORRECTIVE ACTION STATUS === -->
                    {% if action %}
                        {% if action.status == "OPEN" %}
                            <span class="badge bg-danger ms-2">Corrective Action Required</span>
                        {% elif action.status == "IN_PROGRESS" %}
                            <span class="badge bg-warning text-dark ms-2">In Progress</span>
                        {% elif action.status == "AWAITING_REINSPECTION" %}
                            <span class="badge bg-info text-dark ms-2">Awaiting Reinspection</span>
                        {% elif action.status == "REINSPECTED" %}
                            <span class="badge bg-success ms-2">Reinspected</span>
                        {% endif %}
                    {% endif %}
                </div>

                <!-- Right Column: Action Buttons -->
                <div class="text-end">

                    <!-- View Corrective Action -->
                    {% if action %}
                        <a href="{% url 'inspections:corrective_action_detail' action.pk %}"
                           class="btn btn-sm btn-outline-primary mb-1">
                            View Action
                        </a>
                    {% endif %}

                    <!-- Reinspect Button -->
                    {% if action and action.status == "AWAITING_REINSPECTION" %}
                        {% if request.user.appuser.role == "ADMIN" or inspection.inspector == request.user.appuser %}
                            <a href="{% url 'inspections:inspection_perform' inspection.pk %}?action={{ action.pk }}"
                               class="btn btn-sm btn-success">
                                Reinspect
                            </a>
                        {% endif %}
                    {% endif %}
                </div>

            </li>
            {% endwith %}
            {% endfor %}
        </ul>
    </div>

</div>
{% endblock %}
